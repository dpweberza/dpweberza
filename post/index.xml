<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Posts on David Weber</title>
    <link>http://www.davidpaulweber.com/post/index.xml</link>
    <description>Recent content in Posts on David Weber</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en-us</language>
    <managingEditor>dpweberza@gmail.com (David Weber)</managingEditor>
    <webMaster>dpweberza@gmail.com (David Weber)</webMaster>
    <lastBuildDate>Thu, 13 Apr 2017 20:10:59 +0000</lastBuildDate>
    <atom:link href="http://www.davidpaulweber.com/post/index.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>Hibernate Batch Inserts</title>
      <link>http://www.davidpaulweber.com/post/2017-04-13-hibernate-batch-inserts/</link>
      <pubDate>Thu, 13 Apr 2017 20:10:59 +0000</pubDate>
      <author>dpweberza@gmail.com (David Weber)</author>
      <guid>http://www.davidpaulweber.com/post/2017-04-13-hibernate-batch-inserts/</guid>
      <description>&lt;p&gt;The other day I was building our new orders interface in VueJS and I came across a performance problem on large orders where we were creating a large number of Hibernate objects in one request. For 750 objects the request was taking around 2 minutes. This was certainly unacceptable as the whole reason I was building a new orders interface was to scale better and provide a better UX.&lt;/p&gt;

&lt;p&gt;So I started looking at options to do a batch insert instead, unfortunately we are stuck on Hibernate 2 at the moment due to a rather large code base that cannot be easily upgraded.&lt;/p&gt;

&lt;p&gt;I checked for any small jdbc libs but was surprised I couldn&amp;rsquo;t find anything decent.&lt;/p&gt;

&lt;p&gt;Back at square one I was left with stock jdbc and prepared statements. Writing manual sql statements felt icky and I wanted a more generic solution.&lt;/p&gt;

&lt;p&gt;Luckily I figured out how to get Hibernate to generate the prepared statement for me, couple that with some jdbc code and I rolled out a neat util to batch insert any object we had mapped.&lt;/p&gt;

&lt;p&gt;I&amp;rsquo;ll share the code for this utility below, I was happy that I managed to shave that 2 minute request down to 4 seconds with this tool.&lt;/p&gt;

&lt;p&gt;Note the following detail / limitations:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;Each batch must contain only one type of hibernate entity. We might add support for multiple entities if the need arises, we would just cache the meta data and sql for each type when iterating through the batch objects.&lt;/li&gt;
&lt;li&gt;In one case I needed to batch insert a bunch of parent entities, then batch insert a child for each parent using the parents&amp;rsquo; ids, so to do this I pass a connection in, insert the parents in one batch, iterate through the parents and create a new child using the parent&amp;rsquo;s identifier then batch insert the children and close the connection.&lt;/li&gt;
&lt;/ol&gt;

&lt;pre class=&#34;language-java line-numbers&#34;&gt;&lt;code&gt;/**
 * Inserts a List of DataBeans in one batch and sets the ids on the objects.
 * @param objects
 * @param connection - make sure you connection.close your own connection once done.
 * @throws Exception
 */
public void insertObjectsInOneBatch(LinkedList&lt;? extends DataBean&gt; objects, Connection connection) throws Exception
{
    if (objects.isEmpty())
        throw new Exception(&#34;objects argument is empty!&#34;);

    DataBean sampleObject = objects.get(0);

    ClassMetadata hibernateMetadata = HibernateManager.getSessionFactory().getClassMetadata(sampleObject.getClass());
    if (hibernateMetadata == null)
        throw new Exception(&#34;Failed to load hibernate metadata for class: &#34; + sampleObject.getClassName() + &#34;.\\nP.S. This wont work with lazy-loaded builds.&#34;);

    AbstractEntityPersister persister = (AbstractEntityPersister) hibernateMetadata;
    String[] columnNames = persister.getPropertyNames();
    Field sqlInsertString = ReflectionUtil.getField(&#34;sqlInsertString&#34;, persister);
    String sql = (String) sqlInsertString.get(persister);

    PreparedStatement ps = null;
    try
    {
        connection.setAutoCommit(false);
        ps = connection.prepareStatement(sql, Statement.RETURN_GENERATED_KEYS);

        int count = 0;
        for (DataBean object : objects)
        {
            for (int i = 0; i &lt; columnNames.length; i++)
            {
                String columnName = columnNames[i];
                Object propertyValue = persister.getPropertyValue(object, columnName);
                ps.setObject(i + 1, propertyValue);
            }
            ps.setObject(columnNames.length + 1, null); // Set id to null
            ps.addBatch();

            if (++count % batchSize == 0)
                ps.executeBatch();
        }

        ps.executeBatch();
        ResultSet rs = ps.getGeneratedKeys();

        // Set the inserted ids on the objects
        int i = 0;
        while (rs.next())
        {
            long id = rs.getLong(1);
            ReflectionUtil.setField(objects.get(i), &#34;id&#34;, id);
            i++;
        }
    }
    catch (Exception ex)
    {
        LogManager.error(this, ex);
        throw ex;
    }
    finally
    {
        if (ps != null)
            ps.close();
    }
}&lt;/code&gt;&lt;/pre&gt;
</description>
    </item>
    
    <item>
      <title>My work at SOLIDitech</title>
      <link>http://www.davidpaulweber.com/post/2017-04-08-my-work-at-soliditech/</link>
      <pubDate>Sat, 08 Apr 2017 00:00:00 +0000</pubDate>
      <author>dpweberza@gmail.com (David Weber)</author>
      <guid>http://www.davidpaulweber.com/post/2017-04-08-my-work-at-soliditech/</guid>
      <description>

&lt;p&gt;I&amp;rsquo;ve been working at &lt;a href=&#34;https://www.soliditech.com&#34;&gt;SOLIDitech&lt;/a&gt; in Cape Town, South Africa since May 2011.
It&amp;rsquo;s been an amazing experience and as I prepare to move to Melbourne, Australia at the end of April, I figure I should spend some time reflecting on the projects and challenges I worked through.&lt;/p&gt;

&lt;p&gt;First, though, a bit about the company; SOLIDitech is a software firm that develops it&amp;rsquo;s own Business Automation Platform targeted at Internet Service Providers.
We currently employ 53 very talented people and have our platform deployed to 42 customers in 10 countries throughout Africa and Asia.&lt;/p&gt;

&lt;h2 id=&#34;work-overview&#34;&gt;Work Overview&lt;/h2&gt;

&lt;h3 id=&#34;system-migrations&#34;&gt;System Migrations&lt;/h3&gt;

&lt;p&gt;When I first joined SOLIDitech, I was put on a 4-man team that was working on migrating one of our new clients from a legacy platform to our own customised platform.
This was a year-long project that involved developing some new features, billing customisations, service automation and migrating all our client&amp;rsquo;s customer data to our system.&lt;/p&gt;

&lt;p&gt;Some of the features I worked on were:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;Order processing framework - whereby a quote is converted into an order and each order line has a workflow to provision the product.&lt;/li&gt;
&lt;li&gt;RICA and credit vetting - automated credit bureau SOAP API integration, scoring, reporting and order integration.&lt;/li&gt;
&lt;li&gt;Service automation - automated ADSL and Dial-up service provisioning, usage reporting and usage billing.&lt;/li&gt;
&lt;li&gt;Migration framework - service migration plug-ins, data parsing and clean-up.&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;Near the end of the project I was the last remaining original team member and spent 6 month&amp;rsquo;s at the client: 3 months working day-and-night to get ready for the go-live and the 3 months after go-live providing support, fixing bugs and implementing enhancements.&lt;/p&gt;

&lt;p&gt;Since my first migration project, I have successfully migrated data from many more systems to our platform, though migrating to a live system provided more challenges.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;More to follow soon&amp;hellip;&lt;/em&gt;&lt;/p&gt;

&lt;!--
### Service Automation

### Innovations
1. New UI
2. Ajax
3. Quote Builder
4. Product Builder
5. Order Builder

--&gt;
</description>
    </item>
    
  </channel>
</rss>